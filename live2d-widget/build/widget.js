import{ModelManager}from"./model.js";import{showMessage,welcomeMessage}from"./message.js";import{randomSelection}from"./utils.js";import{ToolsManager}from"./tools.js";import logger from"./logger.js";import registerDrag from"./drag.js";import{fa_child}from"./icons.js";function registerEventListener(e){let t,i=!1;const o=e.message.default;let s;e.seasons.forEach(({date:e,text:t})=>{const i=new Date,s=e.split("-")[0],a=e.split("-")[1]||s;Number(s.split("/")[0])<=i.getMonth()+1&&i.getMonth()+1<=Number(a.split("/")[0])&&Number(s.split("/")[1])<=i.getDate()&&i.getDate()<=Number(a.split("/")[1])&&(t=(t=randomSelection(t)).replace("{year}",String(i.getFullYear())),o.push(t))}),window.addEventListener("mousemove",()=>i=!0),window.addEventListener("keydown",()=>i=!0),setInterval(()=>{i?(i=!1,clearInterval(t),t=null):t||(t=setInterval(()=>{showMessage(o,6e3,9)},2e4))},1e3),window.addEventListener("mouseover",t=>{var i;for(let{selector:o,text:a}of e.mouseover)if(null===(i=t.target)||void 0===i?void 0:i.closest(o)){if(s===o)return;return s=o,a=randomSelection(a),a=a.replace("{text}",t.target.innerText),void showMessage(a,4e3,8)}}),window.addEventListener("click",t=>{var i;for(let{selector:o,text:s}of e.click)if(null===(i=t.target)||void 0===i?void 0:i.closest(o))return s=randomSelection(s),s=s.replace("{text}",t.target.innerText),void showMessage(s,4e3,8)}),window.addEventListener("live2d:hoverbody",()=>{const t=randomSelection(e.message.hoverBody);showMessage(t,4e3,8,!1)}),window.addEventListener("live2d:tapbody",()=>{const t=randomSelection(e.message.tapBody);showMessage(t,4e3,9)});const a=()=>{};console.log("%c",a),a.toString=()=>{showMessage(e.message.console,6e3,9)},window.addEventListener("copy",()=>{showMessage(e.message.copy,6e3,9)}),window.addEventListener("visibilitychange",()=>{document.hidden||showMessage(e.message.visibilitychange,6e3,9)})}async function loadWidget(e){var t;localStorage.removeItem("waifu-display"),sessionStorage.removeItem("waifu-message-priority"),document.body.insertAdjacentHTML("beforeend",'<div id="waifu">\n       <div id="waifu-tips"></div>\n       <div id="waifu-canvas">\n         <canvas id="live2d" width="800" height="800"></canvas>\n       </div>\n       <div id="waifu-tool"></div>\n     </div>');let i,o=[];if(e.waifuPath){const t=await fetch(e.waifuPath);i=await t.json(),o=i.models,registerEventListener(i),showMessage(welcomeMessage(i.time,i.message.welcome,i.message.referrer),7e3,11)}const s=await ModelManager.initCheck(e,o);await s.loadModel(""),new ToolsManager(s,e,i).registerTools(),e.drag&&registerDrag(),null===(t=document.getElementById("waifu"))||void 0===t||t.classList.add("waifu-active")}function initWidget(e){if("string"==typeof e)return void logger.error("Your config for Live2D initWidget is outdated. Please refer to https://github.com/stevenjoezhang/live2d-widget/blob/master/dist/autoload.js");logger.setLevel(e.logLevel),document.body.insertAdjacentHTML("beforeend",`<div id="waifu-toggle">\n       ${fa_child}\n     </div>`);const t=document.getElementById("waifu-toggle");null==t||t.addEventListener("click",()=>{var i;null==t||t.classList.remove("waifu-toggle-active"),(null==t?void 0:t.getAttribute("first-time"))?(loadWidget(e),null==t||t.removeAttribute("first-time")):(localStorage.removeItem("waifu-display"),null===(i=document.getElementById("waifu"))||void 0===i||i.classList.remove("waifu-hidden"),setTimeout(()=>{var e;null===(e=document.getElementById("waifu"))||void 0===e||e.classList.add("waifu-active")},0))}),localStorage.getItem("waifu-display")&&Date.now()-Number(localStorage.getItem("waifu-display"))<=864e5?(null==t||t.setAttribute("first-time","true"),setTimeout(()=>{null==t||t.classList.add("waifu-toggle-active")},0)):loadWidget(e)}export{initWidget};