import logger from"../logger.js";class L2DBaseModel{constructor(){this.live2DModel=null,this.modelMatrix=null,this.eyeBlink=null,this.physics=null,this.pose=null,this.initialized=!1,this.updating=!1,this.alpha=1,this.accAlpha=0,this.lipSync=!1,this.lipSyncValue=0,this.accelX=0,this.accelY=0,this.accelZ=0,this.dragX=0,this.dragY=0,this.startTimeMSec=null,this.mainMotionManager=new L2DMotionManager,this.expressionManager=new L2DMotionManager,this.motions={},this.expressions={},this.isTexLoaded=!1}getModelMatrix(){return this.modelMatrix}setAlpha(t){t>.999&&(t=1),t<.001&&(t=0),this.alpha=t}getAlpha(){return this.alpha}isInitialized(){return this.initialized}setInitialized(t){this.initialized=t}isUpdating(){return this.updating}setUpdating(t){this.updating=t}getLive2DModel(){return this.live2DModel}setLipSync(t){this.lipSync=t}setLipSyncValue(t){this.lipSyncValue=t}setAccel(t,e,s){this.accelX=t,this.accelY=e,this.accelZ=s}setDrag(t,e){this.dragX=t,this.dragY=e}getMainMotionManager(){return this.mainMotionManager}getExpressionManager(){return this.expressionManager}loadModelData(t,e){const s=Live2DFramework.getPlatformManager();logger.info("Load model : "+t),s.loadLive2DModel(t,t=>{this.live2DModel=t,this.live2DModel.saveParam();0==Live2D.getError()?(this.modelMatrix=new L2DModelMatrix(this.live2DModel.getCanvasWidth(),this.live2DModel.getCanvasHeight()),this.modelMatrix.setWidth(2),this.modelMatrix.setCenterPosition(0,0),e(this.live2DModel)):logger.error("Error : Failed to loadModelData().")})}loadTexture(t,e,s){texCounter++;const i=Live2DFramework.getPlatformManager();logger.info("Load Texture : "+e),i.loadTexture(this.live2DModel,t,e,()=>{texCounter--,0==texCounter&&(this.isTexLoaded=!0),"function"==typeof s&&s()})}loadMotion(t,e,s){const i=Live2DFramework.getPlatformManager();logger.trace("Load Motion : "+e);let r=null;i.loadBytes(e,e=>{r=Live2DMotion.loadMotion(e),null!=t&&(this.motions[t]=r),s(r)})}loadExpression(t,e,s){const i=Live2DFramework.getPlatformManager();logger.trace("Load Expression : "+e),i.loadBytes(e,e=>{null!=t&&(this.expressions[t]=L2DExpressionMotion.loadJson(e)),"function"==typeof s&&s()})}loadPose(t,e){const s=Live2DFramework.getPlatformManager();logger.trace("Load Pose : "+t);try{s.loadBytes(t,t=>{this.pose=L2DPose.load(t),"function"==typeof e&&e()})}catch(t){logger.warn(t)}}loadPhysics(t){const e=Live2DFramework.getPlatformManager();logger.trace("Load Physics : "+t);try{e.loadBytes(t,t=>{this.physics=L2DPhysics.load(t)})}catch(t){logger.warn(t)}}hitTestSimple(t,e,s){const i=this.live2DModel.getDrawDataIndex(t);if(i<0)return!1;const r=this.live2DModel.getTransformedPoints(i);let a=this.live2DModel.getCanvasWidth(),n=0,o=this.live2DModel.getCanvasHeight(),h=0;for(let t=0;t<r.length;t+=2){const e=r[t],s=r[t+1];e<a&&(a=e),e>n&&(n=e),s<o&&(o=s),s>h&&(h=s)}const l=this.modelMatrix.invertTransformX(e),c=this.modelMatrix.invertTransformY(s);return a<=l&&l<=n&&o<=c&&c<=h}}let texCounter=0;class L2DExpressionMotion extends AMotion{constructor(){super(),this.paramList=[]}static loadJson(t){const e=new L2DExpressionMotion,s=Live2DFramework.getPlatformManager().jsonParseFromBytes(t);if(e.setFadeIn(parseInt(s.fade_in)>0?parseInt(s.fade_in):1e3),e.setFadeOut(parseInt(s.fade_out)>0?parseInt(s.fade_out):1e3),null==s.params)return e;const i=s.params,r=i.length;e.paramList=[];for(let t=0;t<r;t++){const s=i[t],r=s.id.toString();let a=parseFloat(s.val),n=L2DExpressionMotion.TYPE_ADD;const o=null!=s.calc?s.calc.toString():"add";if(n="add"===o?L2DExpressionMotion.TYPE_ADD:"mult"===o?L2DExpressionMotion.TYPE_MULT:"set"===o?L2DExpressionMotion.TYPE_SET:L2DExpressionMotion.TYPE_ADD,n==L2DExpressionMotion.TYPE_ADD){a-=null==s.def?0:parseFloat(s.def)}else if(n==L2DExpressionMotion.TYPE_MULT){let t=null==s.def?1:parseFloat(s.def);0==t&&(t=1),a/=t}const h=new L2DExpressionParam;h.id=r,h.type=n,h.value=a,e.paramList.push(h)}return e}updateParamExe(t,e,s,i){for(let e=this.paramList.length-1;e>=0;--e){const i=this.paramList[e];i.type==L2DExpressionMotion.TYPE_ADD?t.addToParamFloat(i.id,i.value,s):i.type==L2DExpressionMotion.TYPE_MULT?t.multParamFloat(i.id,i.value,s):i.type==L2DExpressionMotion.TYPE_SET&&t.setParamFloat(i.id,i.value,s)}}}function L2DExpressionParam(){this.id="",this.type=-1,this.value=null}L2DExpressionMotion.EXPRESSION_DEFAULT="DEFAULT",L2DExpressionMotion.TYPE_SET=0,L2DExpressionMotion.TYPE_ADD=1,L2DExpressionMotion.TYPE_MULT=2;class L2DEyeBlink{constructor(){this.nextBlinkTime=null,this.stateStartTime=null,this.blinkIntervalMsec=null,this.eyeState=EYE_STATE.STATE_FIRST,this.blinkIntervalMsec=4e3,this.closingMotionMsec=100,this.closedMotionMsec=50,this.openingMotionMsec=150,this.closeIfZero=!0,this.eyeID_L="PARAM_EYE_L_OPEN",this.eyeID_R="PARAM_EYE_R_OPEN"}calcNextBlink(){return UtSystem.getUserTimeMSec()+Math.random()*(2*this.blinkIntervalMsec-1)}setInterval(t){this.blinkIntervalMsec=t}setEyeMotion(t,e,s){this.closingMotionMsec=t,this.closedMotionMsec=e,this.openingMotionMsec=s}updateParam(t){const e=UtSystem.getUserTimeMSec();let s,i=0;switch(this.eyeState){case EYE_STATE.STATE_CLOSING:i=(e-this.stateStartTime)/this.closingMotionMsec,i>=1&&(i=1,this.eyeState=EYE_STATE.STATE_CLOSED,this.stateStartTime=e),s=1-i;break;case EYE_STATE.STATE_CLOSED:i=(e-this.stateStartTime)/this.closedMotionMsec,i>=1&&(this.eyeState=EYE_STATE.STATE_OPENING,this.stateStartTime=e),s=0;break;case EYE_STATE.STATE_OPENING:i=(e-this.stateStartTime)/this.openingMotionMsec,i>=1&&(i=1,this.eyeState=EYE_STATE.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink()),s=i;break;case EYE_STATE.STATE_INTERVAL:this.nextBlinkTime<e&&(this.eyeState=EYE_STATE.STATE_CLOSING,this.stateStartTime=e),s=1;break;case EYE_STATE.STATE_FIRST:default:this.eyeState=EYE_STATE.STATE_INTERVAL,this.nextBlinkTime=this.calcNextBlink(),s=1}this.closeIfZero||(s=-s),t.setParamFloat(this.eyeID_L,s),t.setParamFloat(this.eyeID_R,s)}}const EYE_STATE=()=>{};EYE_STATE.STATE_FIRST="STATE_FIRST",EYE_STATE.STATE_INTERVAL="STATE_INTERVAL",EYE_STATE.STATE_CLOSING="STATE_CLOSING",EYE_STATE.STATE_CLOSED="STATE_CLOSED",EYE_STATE.STATE_OPENING="STATE_OPENING";class L2DMatrix44{constructor(){this.tr=new Float32Array(16),this.identity()}static mul(t,e,s){const i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];let r,a,n;for(r=0;r<4;r++)for(a=0;a<4;a++)for(n=0;n<4;n++)i[r+4*a]+=t[r+4*n]*e[n+4*a];for(r=0;r<16;r++)s[r]=i[r]}identity(){for(let t=0;t<16;t++)this.tr[t]=t%5==0?1:0}getArray(){return this.tr}getCopyMatrix(){return new Float32Array(this.tr)}setMatrix(t){if(null!=this.tr&&this.tr.length==this.tr.length)for(let e=0;e<16;e++)this.tr[e]=t[e]}getScaleX(){return this.tr[0]}getScaleY(){return this.tr[5]}transformX(t){return this.tr[0]*t+this.tr[12]}transformY(t){return this.tr[5]*t+this.tr[13]}invertTransformX(t){return(t-this.tr[12])/this.tr[0]}invertTransformY(t){return(t-this.tr[13])/this.tr[5]}multTranslate(t,e){const s=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];L2DMatrix44.mul(s,this.tr,this.tr)}translate(t,e){this.tr[12]=t,this.tr[13]=e}translateX(t){this.tr[12]=t}translateY(t){this.tr[13]=t}multScale(t,e){const s=[t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1];L2DMatrix44.mul(s,this.tr,this.tr)}scale(t,e){this.tr[0]=t,this.tr[5]=e}}class L2DModelMatrix extends L2DMatrix44{constructor(t,e){super(),this.width=t,this.height=e}setPosition(t,e){this.translate(t,e)}setCenterPosition(t,e){const s=this.width*this.getScaleX(),i=this.height*this.getScaleY();this.translate(t-s/2,e-i/2)}top(t){this.setY(t)}bottom(t){const e=this.height*this.getScaleY();this.translateY(t-e)}left(t){this.setX(t)}right(t){const e=this.width*this.getScaleX();this.translateX(t-e)}centerX(t){const e=this.width*this.getScaleX();this.translateX(t-e/2)}centerY(t){const e=this.height*this.getScaleY();this.translateY(t-e/2)}setX(t){this.translateX(t)}setY(t){this.translateY(t)}setHeight(t){const e=t/this.height,s=-e;this.scale(e,s)}setWidth(t){const e=t/this.width,s=-e;this.scale(e,s)}}class L2DMotionManager extends MotionQueueManager{constructor(){super(),this.currentPriority=null,this.reservePriority=null,this.super=MotionQueueManager.prototype}getCurrentPriority(){return this.currentPriority}getReservePriority(){return this.reservePriority}reserveMotion(t){return!(this.reservePriority>=t)&&(!(this.currentPriority>=t)&&(this.reservePriority=t,!0))}setReservePriority(t){this.reservePriority=t}updateParam(t){const e=MotionQueueManager.prototype.updateParam.call(this,t);return this.isFinished()&&(this.currentPriority=0),e}startMotionPrio(t,e){return e==this.reservePriority&&(this.reservePriority=0),this.currentPriority=e,this.startMotion(t,!1)}}class L2DPhysics{constructor(){this.physicsList=[],this.startTimeMSec=UtSystem.getUserTimeMSec()}static load(t){const e=new L2DPhysics,s=Live2DFramework.getPlatformManager().jsonParseFromBytes(t).physics_hair,i=s.length;for(let t=0;t<i;t++){const i=s[t],r=new PhysicsHair,a=i.setup,n=parseFloat(a.length),o=parseFloat(a.regist),h=parseFloat(a.mass);r.setup(n,o,h);const l=i.src,c=l.length;for(let t=0;t<c;t++){const e=l[t];let s=e.id,i=PhysicsHair.Src.SRC_TO_X,a=e.ptype;"x"===a?i=PhysicsHair.Src.SRC_TO_X:"y"===a?i=PhysicsHair.Src.SRC_TO_Y:"angle"===a?i=PhysicsHair.Src.SRC_TO_G_ANGLE:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Src");let n=parseFloat(e.scale),o=parseFloat(e.weight);r.addSrcParam(i,s,n,o)}const g=i.targets,T=g.length;for(let t=0;t<T;t++){const e=g[t];let s=e.id,i=PhysicsHair.Target.TARGET_FROM_ANGLE,a=e.ptype;"angle"===a?i=PhysicsHair.Target.TARGET_FROM_ANGLE:"angle_v"===a?i=PhysicsHair.Target.TARGET_FROM_ANGLE_V:UtDebug.error("live2d","Invalid parameter:PhysicsHair.Target");let n=parseFloat(e.scale),o=parseFloat(e.weight);r.addTargetParam(i,s,n,o)}e.physicsList.push(r)}return e}updateParam(t){const e=UtSystem.getUserTimeMSec()-this.startTimeMSec;for(let s=0;s<this.physicsList.length;s++)this.physicsList[s].update(t,e)}}class L2DPose{constructor(){this.lastTime=0,this.lastModel=null,this.partsGroups=[]}static load(t){const e=new L2DPose,s=Live2DFramework.getPlatformManager().jsonParseFromBytes(t).parts_visible,i=s.length;for(let t=0;t<i;t++){const i=s[t].group,r=i.length,a=[];for(let t=0;t<r;t++){const e=i[t],s=new L2DPartsParam(e.id);if(a[t]=s,null==e.link)continue;const r=e.link,n=r.length;s.link=[];for(let t=0;t<n;t++){const e=new L2DPartsParam(r[t]);s.link.push(e)}}e.partsGroups.push(a)}return e}updateParam(t){if(null==t)return;t!=this.lastModel&&this.initParam(t),this.lastModel=t;const e=UtSystem.getUserTimeMSec();let s=0==this.lastTime?0:(e-this.lastTime)/1e3;this.lastTime=e,s<0&&(s=0);for(let e=0;e<this.partsGroups.length;e++)this.normalizePartsOpacityGroup(t,this.partsGroups[e],s),this.copyOpacityOtherParts(t,this.partsGroups[e])}initParam(t){if(null!=t)for(let e=0;e<this.partsGroups.length;e++){const s=this.partsGroups[e];for(let e=0;e<s.length;e++){s[e].initIndex(t);const i=s[e].partsIndex,r=s[e].paramIndex;if(i<0)continue;const a=0!=t.getParamFloat(r);if(t.setPartsOpacity(i,a?1:0),t.setParamFloat(r,a?1:0),null!=s[e].link)for(let i=0;i<s[e].link.length;i++)s[e].link[i].initIndex(t)}}}normalizePartsOpacityGroup(t,e,s){let i=-1,r=1;const a=.5;for(let a=0;a<e.length;a++){let n=e[a].partsIndex;const o=e[a].paramIndex;if(!(n<0)&&0!=t.getParamFloat(o)){if(i>=0)break;i=a,r=t.getPartsOpacity(n),r+=s/.5,r>1&&(r=1)}}i<0&&(i=0,r=1);for(let s=0;s<e.length;s++){let n=e[s].partsIndex;if(!(n<0))if(i==s)t.setPartsOpacity(n,r);else{let e,s=t.getPartsOpacity(n);e=r<a?-.5*r/a+1:(1-r)*a/.5;(1-e)*(1-r)>.15&&(e=1-.15/(1-r)),s>e&&(s=e),t.setPartsOpacity(n,s)}}}copyOpacityOtherParts(t,e){for(let s=0;s<e.length;s++){const i=e[s];if(null==i.link)continue;if(i.partsIndex<0)continue;const r=t.getPartsOpacity(i.partsIndex);for(let e=0;e<i.link.length;e++){const s=i.link[e];s.partsIndex<0||t.setPartsOpacity(s.partsIndex,r)}}}}class L2DPartsParam{constructor(t){this.paramIndex=-1,this.partsIndex=-1,this.link=null,this.id=t}initIndex(t){this.paramIndex=t.getParamIndex("VISIBLE:"+this.id),this.partsIndex=t.getPartsDataIndex(PartsDataID.getID(this.id)),t.setParamFloat(this.paramIndex,1)}}class L2DTargetPoint{constructor(){this.EPSILON=.01,this.faceTargetX=0,this.faceTargetY=0,this.faceX=0,this.faceY=0,this.faceVX=0,this.faceVY=0,this.lastTimeSec=0}setPoint(t,e){this.faceTargetX=t,this.faceTargetY=e}getX(){return this.faceX}getY(){return this.faceY}update(){const t=40/7.5/L2DTargetPoint.FRAME_RATE;if(0==this.lastTimeSec)return void(this.lastTimeSec=UtSystem.getUserTimeMSec());const e=UtSystem.getUserTimeMSec(),s=(e-this.lastTimeSec)*L2DTargetPoint.FRAME_RATE/1e3;this.lastTimeSec=e;const i=s*t/(.15*L2DTargetPoint.FRAME_RATE),r=this.faceTargetX-this.faceX,a=this.faceTargetY-this.faceY;if(Math.abs(r)<=this.EPSILON&&Math.abs(a)<=this.EPSILON)return;const n=Math.sqrt(r*r+a*a),o=t*a/n;let h=t*r/n-this.faceVX,l=o-this.faceVY,c=Math.sqrt(h*h+l*l);(c<-i||c>i)&&(h*=i/c,l*=i/c,c=i),this.faceVX+=h,this.faceVY+=l;{const t=.5*(Math.sqrt(i*i+16*i*n-8*i*n)-i),e=Math.sqrt(this.faceVX*this.faceVX+this.faceVY*this.faceVY);e>t&&(this.faceVX*=t/e,this.faceVY*=t/e)}this.faceX+=this.faceVX,this.faceY+=this.faceVY}}L2DTargetPoint.FRAME_RATE=30;class L2DViewMatrix extends L2DMatrix44{constructor(){super(),this.screenLeft=null,this.screenRight=null,this.screenTop=null,this.screenBottom=null,this.maxLeft=null,this.maxRight=null,this.maxTop=null,this.maxBottom=null,this.max=Number.MAX_VALUE,this.min=0}getMaxScale(){return this.max}getMinScale(){return this.min}setMaxScale(t){this.max=t}setMinScale(t){this.min=t}isMaxScale(){return this.getScaleX()==this.max}isMinScale(){return this.getScaleX()==this.min}adjustTranslate(t,e){this.tr[0]*this.maxLeft+(this.tr[12]+t)>this.screenLeft&&(t=this.screenLeft-this.tr[0]*this.maxLeft-this.tr[12]),this.tr[0]*this.maxRight+(this.tr[12]+t)<this.screenRight&&(t=this.screenRight-this.tr[0]*this.maxRight-this.tr[12]),this.tr[5]*this.maxTop+(this.tr[13]+e)<this.screenTop&&(e=this.screenTop-this.tr[5]*this.maxTop-this.tr[13]),this.tr[5]*this.maxBottom+(this.tr[13]+e)>this.screenBottom&&(e=this.screenBottom-this.tr[5]*this.maxBottom-this.tr[13]);const s=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1];L2DMatrix44.mul(s,this.tr,this.tr)}adjustScale(t,e,s){const i=s*this.tr[0];i<this.min?this.tr[0]>0&&(s=this.min/this.tr[0]):i>this.max&&this.tr[0]>0&&(s=this.max/this.tr[0]);const r=[1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1],a=[s,0,0,0,0,s,0,0,0,0,1,0,0,0,0,1],n=[1,0,0,0,0,1,0,0,0,0,1,0,-t,-e,0,1];L2DMatrix44.mul(n,this.tr,this.tr),L2DMatrix44.mul(a,this.tr,this.tr),L2DMatrix44.mul(r,this.tr,this.tr)}setScreenRect(t,e,s,i){this.screenLeft=t,this.screenRight=e,this.screenTop=i,this.screenBottom=s}setMaxScreenRect(t,e,s,i){this.maxLeft=t,this.maxRight=e,this.maxTop=i,this.maxBottom=s}getScreenLeft(){return this.screenLeft}getScreenRight(){return this.screenRight}getScreenBottom(){return this.screenBottom}getScreenTop(){return this.screenTop}getMaxLeft(){return this.maxLeft}getMaxRight(){return this.maxRight}getMaxBottom(){return this.maxBottom}getMaxTop(){return this.maxTop}}class Live2DFramework{static getPlatformManager(){return Live2DFramework.platformManager}static setPlatformManager(t){Live2DFramework.platformManager=t}}Live2DFramework.platformManager=null;export{L2DBaseModel,L2DViewMatrix,L2DEyeBlink,Live2DFramework,L2DMatrix44,L2DTargetPoint};