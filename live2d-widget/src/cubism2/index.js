import{L2DMatrix44,L2DTargetPoint,L2DViewMatrix}from"./Live2DFramework.js";import LAppDefine from"./LAppDefine.js";import MatrixStack from"./utils/MatrixStack.js";import LAppLive2DManager from"./LAppLive2DManager.js";import logger from"../logger.js";function normalizePoint(e,t,i,n,s,a){const r=e-i,o=t-n;let h=0,l=0;return h=r>=0?r/(s-i):r/i,l=o>=0?o/(a-n):o/n,{vx:h,vy:-l}}class Cubism2Model{constructor(){this.live2DMgr=new LAppLive2DManager,this.isDrawStart=!1,this.gl=null,this.canvas=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null,this.oldLen=0,this._boundMouseEvent=this.mouseEvent.bind(this),this._boundTouchEvent=this.touchEvent.bind(this)}initL2dCanvas(e){this.canvas=document.getElementById(e),this.canvas.addEventListener&&(this.canvas.addEventListener("mousewheel",this._boundMouseEvent,!1),this.canvas.addEventListener("click",this._boundMouseEvent,!1),document.addEventListener("mousemove",this._boundMouseEvent,!1),document.addEventListener("mouseout",this._boundMouseEvent,!1),this.canvas.addEventListener("contextmenu",this._boundMouseEvent,!1),this.canvas.addEventListener("touchstart",this._boundTouchEvent,!1),this.canvas.addEventListener("touchend",this._boundTouchEvent,!1),this.canvas.addEventListener("touchmove",this._boundTouchEvent,!1))}async init(e,t,i){this.initL2dCanvas(e);const n=this.canvas.width,s=this.canvas.height;this.dragMgr=new L2DTargetPoint;const a=s/n,r=LAppDefine.VIEW_LOGICAL_LEFT,o=LAppDefine.VIEW_LOGICAL_RIGHT,h=-a,l=a;this.viewMatrix=new L2DViewMatrix,this.viewMatrix.setScreenRect(r,o,h,l),this.viewMatrix.setMaxScreenRect(LAppDefine.VIEW_LOGICAL_MAX_LEFT,LAppDefine.VIEW_LOGICAL_MAX_RIGHT,LAppDefine.VIEW_LOGICAL_MAX_BOTTOM,LAppDefine.VIEW_LOGICAL_MAX_TOP),this.viewMatrix.setMaxScale(LAppDefine.VIEW_MAX_SCALE),this.viewMatrix.setMinScale(LAppDefine.VIEW_MIN_SCALE),this.projMatrix=new L2DMatrix44,this.projMatrix.multScale(1,n/s),this.deviceToScreen=new L2DMatrix44,this.deviceToScreen.multTranslate(-n/2,-s/2),this.deviceToScreen.multScale(2/n,-2/n),this.gl=this.canvas.getContext("webgl2",{premultipliedAlpha:!0,preserveDrawingBuffer:!0}),this.gl?(Live2D.setGL(this.gl),this.gl.clearColor(0,0,0,0),await this.changeModelWithJSON(t,i),this.startDraw()):logger.error("Failed to create WebGL context.")}destroy(){this.canvas&&(this.canvas.removeEventListener("mousewheel",this._boundMouseEvent,!1),this.canvas.removeEventListener("click",this._boundMouseEvent,!1),document.removeEventListener("mousemove",this._boundMouseEvent,!1),document.removeEventListener("mouseout",this._boundMouseEvent,!1),this.canvas.removeEventListener("contextmenu",this._boundMouseEvent,!1),this.canvas.removeEventListener("touchstart",this._boundTouchEvent,!1),this.canvas.removeEventListener("touchend",this._boundTouchEvent,!1),this.canvas.removeEventListener("touchmove",this._boundTouchEvent,!1)),this._drawFrameId&&(window.cancelAnimationFrame(this._drawFrameId),this._drawFrameId=null),this.isDrawStart=!1,this.live2DMgr&&"function"==typeof this.live2DMgr.release&&this.live2DMgr.release(),this.gl,this.canvas=null,this.gl=null,this.dragMgr=null,this.viewMatrix=null,this.projMatrix=null,this.deviceToScreen=null}startDraw(){if(!this.isDrawStart){this.isDrawStart=!0;const e=()=>{this.draw(),this._drawFrameId=window.requestAnimationFrame(e,this.canvas)};e()}}draw(){MatrixStack.reset(),MatrixStack.loadIdentity(),this.dragMgr.update(),this.live2DMgr.setDrag(this.dragMgr.getX(),this.dragMgr.getY()),this.gl.clear(this.gl.COLOR_BUFFER_BIT),MatrixStack.multMatrix(this.projMatrix.getArray()),MatrixStack.multMatrix(this.viewMatrix.getArray()),MatrixStack.push();const e=this.live2DMgr.getModel();null!=e&&(e.initialized&&!e.updating&&(e.update(),e.draw(this.gl)),MatrixStack.pop())}async changeModel(e){await this.live2DMgr.changeModel(this.gl,e)}async changeModelWithJSON(e,t){await this.live2DMgr.changeModelWithJSON(this.gl,e,t)}modelScaling(e){const t=this.viewMatrix.isMaxScale(),i=this.viewMatrix.isMinScale();this.viewMatrix.adjustScale(0,0,e),t||this.viewMatrix.isMaxScale()&&this.live2DMgr.maxScaleEvent(),i||this.viewMatrix.isMinScale()&&this.live2DMgr.minScaleEvent()}modelTurnHead(e){const t=this.canvas.getBoundingClientRect(),{vx:i,vy:n}=normalizePoint(e.clientX,e.clientY,t.left+t.width/2,t.top+t.height/2,window.innerWidth,window.innerHeight);logger.trace("onMouseDown device( x:"+e.clientX+" y:"+e.clientY+" ) view( x:"+i+" y:"+n+")"),this.dragMgr.setPoint(i,n),this.live2DMgr.tapEvent(i,n),this.live2DMgr?.model.hitTest(LAppDefine.HIT_AREA_BODY,i,n)&&window.dispatchEvent(new Event("live2d:tapbody"))}followPointer(e){const t=this.canvas.getBoundingClientRect(),{vx:i,vy:n}=normalizePoint(e.clientX,e.clientY,t.left+t.width/2,t.top+t.height/2,window.innerWidth,window.innerHeight);logger.trace("onMouseMove device( x:"+e.clientX+" y:"+e.clientY+" ) view( x:"+i+" y:"+n+")"),this.dragMgr.setPoint(i,n),this.live2DMgr?.model.hitTest(LAppDefine.HIT_AREA_BODY,i,n)&&window.dispatchEvent(new Event("live2d:hoverbody"))}lookFront(){this.dragMgr.setPoint(0,0)}mouseEvent(e){e.preventDefault(),"mousewheel"==e.type?e.wheelDelta>0?this.modelScaling(1.1):this.modelScaling(.9):"click"==e.type||"contextmenu"==e.type?this.modelTurnHead(e):"mousemove"==e.type?this.followPointer(e):"mouseout"==e.type&&this.lookFront()}touchEvent(e){e.preventDefault();const t=e.touches[0];if("touchstart"==e.type)1==e.touches.length&&this.modelTurnHead(t);else if("touchmove"==e.type){if(this.followPointer(t),2==e.touches.length){const t=e.touches[0],i=e.touches[1],n=Math.pow(t.pageX-i.pageX,2)+Math.pow(t.pageY-i.pageY,2);this.oldLen-n<0?this.modelScaling(1.025):this.modelScaling(.975),this.oldLen=n}}else"touchend"==e.type&&this.lookFront()}transformViewX(e){const t=this.deviceToScreen.transformX(e);return this.viewMatrix.invertTransformX(t)}transformViewY(e){const t=this.deviceToScreen.transformY(e);return this.viewMatrix.invertTransformY(t)}transformScreenX(e){return this.deviceToScreen.transformX(e)}transformScreenY(e){return this.deviceToScreen.transformY(e)}}export default Cubism2Model;